<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StockFlow - Warehouse & Fleet</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f7fa; }
    
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .login-box {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      width: 90%;
      max-width: 400px;
    }
    
    .login-box h2 {
      margin-bottom: 10px;
      color: #333;
    }
    
    .login-box p {
      color: #666;
      margin-bottom: 25px;
      font-size: 14px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-size: 14px;
      font-weight: 500;
    }
    
    .form-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn-login {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .btn-login:hover {
      opacity: 0.9;
    }
    
    .error-msg {
      background: #fee;
      color: #c33;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 14px;
    }
    
    .app-container {
      display: none;
    }
    
    .app-container.active {
      display: flex;
    }
    
    .sidebar {
      width: 250px;
      background: #2c3e50;
      color: white;
      min-height: 100vh;
      padding: 20px 0;
    }
    
    .logo {
      padding: 0 20px 20px;
      border-bottom: 1px solid #34495e;
      margin-bottom: 20px;
    }
    
    .logo h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    
    .logo p {
      font-size: 12px;
      color: #95a5a6;
    }
    
    .nav-item {
      padding: 12px 20px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .nav-item:hover {
      background: #34495e;
    }
    
    .nav-item.active {
      background: #667eea;
      border-left: 4px solid white;
    }
    
    .main-content {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e1e8ed;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #667eea;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-success {
      background: #27ae60;
      color: white;
    }
    
    .btn-danger {
      background: #e74c3c;
      color: white;
    }
    
    .btn-secondary {
      background: #95a5a6;
      color: white;
    }
    
    .btn:hover {
      opacity: 0.9;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .stat-card h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }
    
    .stat-card .value {
      font-size: 32px;
      font-weight: bold;
      color: #333;
    }
    
    .stat-card .detail {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }
    
    .card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .card h2 {
      margin-bottom: 20px;
      color: #333;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    table th {
      background: #f8f9fa;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #555;
      border-bottom: 2px solid #e1e8ed;
    }
    
    table td {
      padding: 12px;
      border-bottom: 1px solid #e1e8ed;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .badge-pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .badge-approved {
      background: #d4edda;
      color: #155724;
    }
    
    .badge-denied {
      background: #f8d7da;
      color: #721c24;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .form-full {
      grid-column: 1 / -1;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .section {
      display: none;
    }
    
    .section.active {
      display: block;
    }
    
    .filter-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .filter-tab {
      padding: 8px 16px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .filter-tab.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    .chart-container {
      height: 300px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="login-container">
    <div class="login-box">
      <h2>StockFlow</h2>
      <p>Warehouse & Fleet Management</p>
      <div id="loginError" class="error-msg" style="display:none;"></div>
      <form id="loginForm">
        <div class="form-group">
          <label>Employee Code</label>
          <input type="text" id="loginCode" placeholder="e.g., ADMIN01" required>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="loginPassword" placeholder="Enter password" required>
        </div>
        <button type="submit" class="btn-login">Sign In</button>
      </form>
      <p style="margin-top: 20px; font-size: 12px; color: #999;">Connected to Supabase</p>
    </div>
  </div>

  <!-- Main App -->
  <div id="appScreen" class="app-container">
    <div class="sidebar">
      <div class="logo">
        <h1>StockFlow</h1>
        <p>Warehouse & Fleet MVP</p>
      </div>
      <div class="nav-item active" data-section="dashboard">üìä Dashboard</div>
      <div class="nav-item" data-section="products">üì¶ Products</div>
      <div class="nav-item" data-section="requests">üìã Requests</div>
      <div class="nav-item" data-section="fleet">üöö Fleet</div>
      <div class="nav-item" data-section="reports">üìà Reports</div>
      <div class="nav-item" data-section="users" id="usersNav" style="display:none;">üë• Users</div>
    </div>

    <div class="main-content">
      <div class="header">
        <h1 id="sectionTitle">Dashboard</h1>
        <div class="user-info">
          <div class="avatar" id="userAvatar">U</div>
          <div>
            <div id="userName">User</div>
            <div style="font-size: 12px; color: #999;" id="userRole">Role</div>
          </div>
          <button class="btn btn-secondary" onclick="logout()">Logout</button>
        </div>
      </div>

      <!-- Dashboard Section -->
      <div id="dashboard" class="section active">
        <div class="stats-grid">
          <div class="stat-card">
            <h3>Total Products</h3>
            <div class="value" id="totalProducts">0</div>
            <div class="detail" id="topProduct">‚Äî</div>
          </div>
          <div class="stat-card">
            <h3>Total Requests</h3>
            <div class="value" id="totalRequests">0</div>
            <div class="detail" id="pendingRequests">Pending: 0</div>
          </div>
          <div class="stat-card">
            <h3>Fleet Activities</h3>
            <div class="value" id="totalFleet">0</div>
            <div class="detail" id="lastActivity">‚Äî</div>
          </div>
        </div>

        <div class="card">
          <h2>Recent Requests</h2>
          <table>
            <thead>
              <tr>
                <th>Request ID</th>
                <th>Employee</th>
                <th>Product</th>
                <th>Qty</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="recentRequestsTable">
              <tr><td colspan="5" style="text-align:center; color:#999;">No requests yet</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Products Section -->
      <div id="products" class="section">
        <div class="btn-group">
          <button class="btn btn-primary" onclick="showAddProduct()">‚ûï Add Product</button>
        </div>

        <div id="addProductForm" class="card" style="display:none; margin-top:20px;">
          <h2>Add New Product</h2>
          <form id="productForm">
            <div class="form-row">
              <div>
                <label>Product Name</label>
                <input type="text" id="productName" required>
              </div>
              <div>
                <label>Quantity</label>
                <input type="number" id="productQty" min="0" value="0" required>
              </div>
            </div>
            <div class="form-full">
              <label>Description</label>
              <textarea id="productDesc"></textarea>
            </div>
            <div class="btn-group">
              <button type="submit" class="btn btn-success">Save Product</button>
              <button type="button" class="btn btn-secondary" onclick="hideAddProduct()">Cancel</button>
            </div>
          </form>
        </div>

        <div class="card" style="margin-top:20px;">
          <h2>All Products</h2>
          <table>
            <thead>
              <tr>
                <th>Product</th>
                <th>Description</th>
                <th>Stock</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="productsTable">
              <tr><td colspan="4" style="text-align:center; color:#999;">No products</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Requests Section -->
      <div id="requests" class="section">
        <div class="btn-group">
          <button class="btn btn-primary" onclick="showNewRequest()">‚ûï New Request</button>
        </div>

        <div id="newRequestForm" class="card" style="display:none; margin-top:20px;">
          <h2>New Product Request</h2>
          <form id="requestForm">
            <div class="form-row">
              <div>
                <label>Product</label>
                <select id="requestProduct" required>
                  <option value="">Select product...</option>
                </select>
              </div>
              <div>
                <label>Quantity</label>
                <input type="number" id="requestQty" min="1" value="1" required>
              </div>
            </div>
            <div class="btn-group">
              <button type="submit" class="btn btn-success">Submit Request</button>
              <button type="button" class="btn btn-secondary" onclick="hideNewRequest()">Cancel</button>
            </div>
          </form>
        </div>

        <div class="card" style="margin-top:20px;">
          <h2>Product Requests</h2>
          <div class="filter-tabs">
            <div class="filter-tab active" data-filter="all">All</div>
            <div class="filter-tab" data-filter="pending">Pending</div>
            <div class="filter-tab" data-filter="approved">Approved</div>
            <div class="filter-tab" data-filter="denied">Denied</div>
          </div>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Employee</th>
                <th>Product</th>
                <th>Qty</th>
                <th>Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="requestsTable">
              <tr><td colspan="7" style="text-align:center; color:#999;">No requests</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Fleet Section -->
      <div id="fleet" class="section">
        <div class="btn-group">
          <button class="btn btn-primary" onclick="showAddActivity()">‚ûï Add Activity</button>
        </div>

        <div id="addActivityForm" class="card" style="display:none; margin-top:20px;">
          <h2>Log Fleet Activity</h2>
          <form id="activityForm">
            <div class="form-row">
              <div>
                <label>Vehicle ID</label>
                <input type="text" id="activityVehicle" required>
              </div>
              <div>
                <label>Driver</label>
                <input type="text" id="activityDriver" required>
              </div>
            </div>
            <div class="form-row">
              <div>
                <label>Activity Type</label>
                <select id="activityType" required>
                  <option value="Delivery">Delivery</option>
                  <option value="Pickup">Pickup</option>
                  <option value="Transfer">Transfer</option>
                  <option value="Maintenance">Maintenance</option>
                </select>
              </div>
            </div>
            <div class="form-full">
              <label>Notes</label>
              <textarea id="activityNotes"></textarea>
            </div>
            <div class="btn-group">
              <button type="submit" class="btn btn-success">Save Activity</button>
              <button type="button" class="btn btn-secondary" onclick="hideAddActivity()">Cancel</button>
            </div>
          </form>
        </div>

        <div class="card" style="margin-top:20px;">
          <h2>All Activities</h2>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Vehicle</th>
                <th>Driver</th>
                <th>Type</th>
                <th>Date</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody id="fleetTable">
              <tr><td colspan="6" style="text-align:center; color:#999;">No activities</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Reports Section -->
      <div id="reports" class="section">
        <div class="card">
          <h2>Requests by Status</h2>
          <div class="chart-container">
            <canvas id="statusChart"></canvas>
          </div>
        </div>
        <div class="card">
          <h2>Top Products</h2>
          <div class="chart-container">
            <canvas id="productsChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Users Section (Admin only) -->
      <div id="users" class="section">
        <div class="btn-group">
          <button class="btn btn-primary" onclick="showAddUser()">‚ûï Add User</button>
        </div>

        <div id="addUserForm" class="card" style="display:none; margin-top:20px;">
          <h2>Add New User</h2>
          <form id="userForm">
            <div class="form-row">
              <div>
                <label>Employee Code</label>
                <input type="text" id="userCode" required>
              </div>
              <div>
                <label>Email</label>
                <input type="email" id="userEmail" required>
              </div>
            </div>
            <div class="form-row">
              <div>
                <label>Password</label>
                <input type="password" id="userPassword" required>
              </div>
              <div>
                <label>Role</label>
                <select id="userRole" required>
                  <option value="employee">Employee</option>
                  <option value="warehouse">Warehouse</option>
                  <option value="admin">Admin</option>
                </select>
              </div>
            </div>
            <div class="btn-group">
              <button type="submit" class="btn btn-success">Create User</button>
              <button type="button" class="btn btn-secondary" onclick="hideAddUser()">Cancel</button>
            </div>
          </form>
        </div>

        <div class="card" style="margin-top:20px;">
          <h2>All Users</h2>
          <table>
            <thead>
              <tr>
                <th>Code</th>
                <th>Email</th>
                <th>Role</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersTable">
              <tr><td colspan="4" style="text-align:center; color:#999;">No users</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========================================
    // SUPABASE CONFIGURATION
    // ========================================
    // REPLACE THESE WITH YOUR ACTUAL SUPABASE CREDENTIALS
    const SUPABASE_URL = 'https://jjqeyscynavlfjzywprf.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqcWV5c2N5bmF2bGZqenl3cHJmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2OTM5NDYsImV4cCI6MjA3OTI2OTk0Nn0.lTF2cWSnAa8xsWi7tWaGCsOAhANkqmuqtMLR9HyPFyY';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    let currentUser = null;
    let allProducts = [];
    let allRequests = [];
    let allActivities = [];
    let allUsers = [];

    // ========================================
    // AUTHENTICATION
    // ========================================
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const code = document.getElementById('loginCode').value;
      const password = document.getElementById('loginPassword').value;
      
      try {
        // Query user by emp_code
        const { data: users, error } = await supabase
          .from('users')
          .select('*')
          .eq('emp_code', code);
        
        if (error) {
          console.error('Supabase error:', error);
          throw new Error(`Database error: ${error.message}. Please check that the 'users' table exists and is accessible.`);
        }
        
        if (users && users.length > 0) {
          const user = users[0];
          // Simple password check (in production, use proper hashing)
          if (user.password === password) {
            currentUser = user;
            showApp();
          } else {
            showError('Invalid credentials');
          }
        } else {
          showError('User not found');
        }
      } catch (err) {
        console.error('Full error:', err);
        showError(err.message);
      }
    });

    function showError(msg) {
      const errorDiv = document.getElementById('loginError');
      errorDiv.textContent = msg;
      errorDiv.style.display = 'block';
      setTimeout(() => errorDiv.style.display = 'none', 3000);
    }

    function showApp() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('appScreen').classList.add('active');
      
      // Set user info
      document.getElementById('userName').textContent = currentUser.emp_code;
      document.getElementById('userRole').textContent = currentUser.role;
      document.getElementById('userAvatar').textContent = currentUser.emp_code[0];
      
      // Show users nav if admin
      if (currentUser.role === 'admin') {
        document.getElementById('usersNav').style.display = 'block';
      }
      
      loadAllData();
    }

    function logout() {
      currentUser = null;
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('appScreen').classList.remove('active');
      document.getElementById('loginCode').value = '';
      document.getElementById('loginPassword').value = '';
    }

    // ========================================
    // DATA LOADING
    // ========================================
    async function loadAllData() {
      await loadProducts();
      await loadRequests();
      await loadFleetActivities();
      if (currentUser.role === 'admin') {
        await loadUsers();
      }
      updateDashboard();
      updateCharts();
    }

    async function loadProducts() {
      const { data, error } = await supabase
        .from('products')
        .select('*')
        .order('name');
      
      if (!error && data) {
        allProducts = data;
        renderProducts();
        populateProductSelect();
      }
    }

    async function loadRequests() {
      const { data, error } = await supabase
        .from('requests')
        .select(`
          *,
          user:users(emp_code),
          product:products(name)
        `)
        .order('created_at', { ascending: false });
      
      if (!error && data) {
        allRequests = data;
        renderRequests();
      }
    }

    async function loadFleetActivities() {
      const { data, error } = await supabase
        .from('fleet_activities')
        .select('*')
        .order('created_at', { ascending: false });
      
      if (!error && data) {
        allActivities = data;
        renderFleetActivities();
      }
    }

    async function loadUsers() {
      const { data, error } = await supabase
        .from('users')
        .select('*')
        .order('emp_code');
      
      if (!error && data) {
        allUsers = data;
        renderUsers();
      }
    }

    // ========================================
    // PRODUCTS
    // ========================================
    function showAddProduct() {
      document.getElementById('addProductForm').style.display = 'block';
    }

    function hideAddProduct() {
      document.getElementById('addProductForm').style.display = 'none';
      document.getElementById('productForm').reset();
    }

    document.getElementById('productForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const { error } = await supabase
        .from('products')
        .insert([{
          name: document.getElementById('productName').value,
          description: document.getElementById('productDesc').value,
          quantity: parseInt(document.getElementById('productQty').value)
        }]);
      
      if (!error) {
        hideAddProduct();
        await loadProducts();
        updateDashboard();
      } else {
        alert('Error adding product: ' + error.message);
      }
    });

    function renderProducts() {
      const tbody = document.getElementById('productsTable');
      if (allProducts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#999;">No products</td></tr>';
        return;
      }
      
      tbody.innerHTML = allProducts.map(p => `
        <tr>
          <td><strong>${p.name}</strong></td>
          <td>${p.description || '‚Äî'}</td>
          <td>${p.quantity}</td>
          <td>
            <button class="btn btn-danger" onclick="deleteProduct('${p.id}')">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    async function deleteProduct(id) {
      if (!confirm('Delete this product?')) return;
      
      const { error } = await supabase
        .from('products')
        .delete()
        .eq('id', id);
      
      if (!error) {
        await loadProducts();
        updateDashboard();
      }
    }

    function populateProductSelect() {
      const select = document.getElementById('requestProduct');
      select.innerHTML = '<option value="">Select product...</option>' +
        allProducts.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    }

    // ========================================
    // REQUESTS
    // ========================================
    function showNewRequest() {
      document.getElementById('newRequestForm').style.display = 'block';
    }

    function hideNewRequest() {
      document.getElementById('newRequestForm').style.display = 'none';
      document.getElementById('requestForm').reset();
    }

    document.getElementById('requestForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const { error } = await supabase
        .from('requests')
        .insert([{
          user_id: currentUser.id,
          product_id: document.getElementById('requestProduct').value,
          quantity: parseInt(document.getElementById('requestQty').value),
          status: 'pending'
        }]);
      
      if (!error) {
        hideNewRequest();
        await loadRequests();
        updateDashboard();
      } else {
        alert('Error creating request: ' + error.message);
      }
    });

    function renderRequests(filter = 'all') {
      let filtered = allRequests;
      if (filter !== 'all') {
        filtered = allRequests.filter(r => r.status === filter);
      }
      
      const tbody = document.getElementById('requestsTable');
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#999;">No requests</td></tr>';
        return;
      }
      
      tbody.innerHTML = filtered.map(r => `
        <tr>
          <td>${r.id.slice(0, 8)}</td>
          <td>${r.user?.emp_code || 'Unknown'}</td>
          <td>${r.product?.name || 'Unknown'}</td>
          <td>${r.quantity}</td>
          <td>${new Date(r.created_at).toLocaleDateString()}</td>
          <td><span class="badge badge-${r.status}">${r.status}</span></td>
          <td>
            ${currentUser.role === 'admin' || currentUser.role === 'warehouse' ? `
              ${r.status === 'pending' ? `
                <button class="btn btn-success" onclick="updateRequestStatus('${r.id}', 'approved')">Approve</button>
                <button class="btn btn-danger" onclick="updateRequestStatus('${r.id}', 'denied')">Deny</button>
              ` : '‚Äî'}
            ` : '‚Äî'}
          </td>
        </tr>
      `).join('');
    }

    async function updateRequestStatus(id, status) {
      const { error } = await supabase
        .from('requests')
        .update({ status })
        .eq('id', id);
      
      if (!error) {
        await loadRequests();
        updateDashboard();
        updateCharts();
      }
    }

    // Filter tabs
    document.querySelectorAll('.filter-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        renderRequests(tab.dataset.filter);
      });
    });

    // ========================================
    // FLEET ACTIVITIES
    // ========================================
    function showAddActivity() {
      document.getElementById('addActivityForm').style.display = 'block';
    }

    function hideAddActivity() {
      document.getElementById('addActivityForm').style.display = 'none';
      document.getElementById('activityForm').reset();
    }

    document.getElementById('activityForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const { error } = await supabase
        .from('fleet_activities')
        .insert([{
          vehicle: document.getElementById('activityVehicle').value,
          operator: document.getElementById('activityDriver').value,
          activity: document.getElementById('activityType').value + ' - ' + 
                    (document.getElementById('activityNotes').value || 'No notes')
        }]);
      
      if (!error) {
        hideAddActivity();
        await loadFleetActivities();
        updateDashboard();
      } else {
        alert('Error adding activity: ' + error.message);
      }
    });

    function renderFleetActivities() {
      const tbody = document.getElementById('fleetTable');
      if (allActivities.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#999;">No activities</td></tr>';
        return;
      }
      
      tbody.innerHTML = allActivities.map(a => `
        <tr>
          <td>${a.id.slice(0, 8)}</td>
          <td>${a.vehicle}</td>
          <td>${a.operator}</td>
          <td>${a.activity.split(' - ')[0]}</td>
          <td>${new Date(a.created_at).toLocaleDateString()}</td>
          <td>${a.activity.split(' - ')[1] || '‚Äî'}</td>
        </tr>
      `).join('');
    }

    // ========================================
    // USERS (Admin only)
    // ========================================
    function showAddUser() {
      document.getElementById('addUserForm').style.display = 'block';
    }

    function hideAddUser() {
      document.getElementById('addUserForm').style.display = 'none';
      document.getElementById('userForm').reset();
    }

    document.getElementById('userForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const userData = {
        emp_code: document.getElementById('userCode').value,
        email: document.getElementById('userEmail').value,
        password: document.getElementById('userPassword').value,
        role: document.getElementById('userRoleSelect').value
      };
      
      console.log('Creating user with data:', userData);
      
      const { error } = await supabase
        .from('users')
        .insert([userData]);
      
      if (!error) {
        hideAddUser();
        await loadUsers();
        alert('User created successfully!');
      } else {
        console.error('User creation error:', error);
        alert('Error creating user: ' + error.message);
      }
    });

    function renderUsers() {
      const tbody = document.getElementById('usersTable');
      if (allUsers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#999;">No users</td></tr>';
        return;
      }
      
      tbody.innerHTML = allUsers.map(u => `
        <tr>
          <td><strong>${u.emp_code}</strong></td>
          <td>${u.email}</td>
          <td>${u.role}</td>
          <td>
            <button class="btn btn-danger" onclick="deleteUser('${u.id}')">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    async function deleteUser(id) {
      if (id === currentUser.id) {
        alert('Cannot delete your own account');
        return;
      }
      if (!confirm('Delete this user?')) return;
      
      const { error } = await supabase
        .from('users')
        .delete()
        .eq('id', id);
      
      if (!error) {
        await loadUsers();
      }
    }

    // ========================================
    // DASHBOARD
    // ========================================
    function updateDashboard() {
      // Products stats
      document.getElementById('totalProducts').textContent = allProducts.length;
      if (allProducts.length > 0) {
        const top = allProducts.reduce((max, p) => p.quantity > max.quantity ? p : max);
        document.getElementById('topProduct').textContent = `Top: ${top.name} (${top.quantity})`;
      }
      
      // Requests stats
      document.getElementById('totalRequests').textContent = allRequests.length;
      const pending = allRequests.filter(r => r.status === 'pending').length;
      document.getElementById('pendingRequests').textContent = `Pending: ${pending}`;
      
      // Fleet stats
      document.getElementById('totalFleet').textContent = allActivities.length;
      if (allActivities.length > 0) {
        const last = allActivities[0];
        document.getElementById('lastActivity').textContent = 
          `Last: ${last.activity.split(' - ')[0]} (${last.vehicle})`;
      }
      
      // Recent requests table
      const recent = allRequests.slice(0, 5);
      const tbody = document.getElementById('recentRequestsTable');
      if (recent.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#999;">No requests yet</td></tr>';
      } else {
        tbody.innerHTML = recent.map(r => `
          <tr>
            <td>${r.id.slice(0, 8)}</td>
            <td>${r.user?.emp_code || 'Unknown'}</td>
            <td>${r.product?.name || 'Unknown'}</td>
            <td>${r.quantity}</td>
            <td><span class="badge badge-${r.status}">${r.status}</span></td>
          </tr>
        `).join('');
      }
    }

    // ========================================
    // CHARTS
    // ========================================
    let statusChart, productsChart;

    function updateCharts() {
      // Status chart
      const statusCounts = {
        pending: allRequests.filter(r => r.status === 'pending').length,
        approved: allRequests.filter(r => r.status === 'approved').length,
        denied: allRequests.filter(r => r.status === 'denied').length
      };
      
      const statusCtx = document.getElementById('statusChart');
      if (statusChart) statusChart.destroy();
      statusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: ['Pending', 'Approved', 'Denied'],
          datasets: [{
            data: [statusCounts.pending, statusCounts.approved, statusCounts.denied],
            backgroundColor: ['#ffc107', '#28a745', '#dc3545']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
      
      // Top products chart
      const topProducts = allProducts
        .sort((a, b) => b.quantity - a.quantity)
        .slice(0, 5);
      
      const productsCtx = document.getElementById('productsChart');
      if (productsChart) productsChart.destroy();
      productsChart = new Chart(productsCtx, {
        type: 'bar',
        data: {
          labels: topProducts.map(p => p.name),
          datasets: [{
            label: 'Stock Quantity',
            data: topProducts.map(p => p.quantity),
            backgroundColor: '#667eea'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    // ========================================
    // NAVIGATION
    // ========================================
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        const section = item.dataset.section;
        
        // Update active nav
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        
        // Update active section
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(section).classList.add('active');
        
        // Update title
        const titles = {
          dashboard: 'Dashboard',
          products: 'Products',
          requests: 'Product Requests',
          fleet: 'Fleet Activities',
          reports: 'Reports & Analytics',
          users: 'User Management'
        };
        document.getElementById('sectionTitle').textContent = titles[section];
      });
    });

    // ========================================
    // INITIALIZATION
    // ========================================
    // Check if Supabase is configured
    if (SUPABASE_URL === 'YOUR_SUPABASE_URL') {
      alert('‚ö†Ô∏è Please configure your Supabase credentials in the script!\n\nReplace SUPABASE_URL and SUPABASE_KEY with your actual values.');
    }

    // Test database connection on page load
    async function testConnection() {
      try {
        console.log('Testing Supabase connection...');
        const { data, error } = await supabase.from('users').select('count');
        if (error) {
          console.error('‚ùå Connection test failed:', error);
          console.log('Please verify:');
          console.log('1. Tables exist in Supabase');
          console.log('2. SUPABASE_URL and SUPABASE_KEY are correct');
          console.log('3. RLS policies are configured');
        } else {
          console.log('‚úÖ Connected to Supabase successfully');
          console.log('Users table exists and is accessible');
        }
      } catch (err) {
        console.error('‚ùå Connection error:', err);
      }
    }
    
    testConnection();
  </script>
</body>
</html>
